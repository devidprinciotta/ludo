<script>
    const GH_TOKEN = "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"; 
    const GH_USER = "devidprinciotta";
    const GH_REPO = "ludo";
    const GH_PATH = "ludo.json";
    const ADMIN_CODE = "1234"; // MODIFIE TON CODE ICI

    let games = [], currentFilter = 'ALL', isNewestFirst = false, selectedConsole = 'PS4', activeId = null, currentSha = null, pz = null, isAuthenticated = false;

    // --- SÃ‰CURITÃ‰ ET AUTHENTIFICATION ---
    function askAuth() {
        if(isAuthenticated) { 
            isAuthenticated = false; 
            updateUI(); 
            return; 
        }
        const p = prompt("Code Administrateur :");
        if(p === ADMIN_CODE) { 
            isAuthenticated = true; 
            updateUI(); 
        } else { 
            alert("Code incorrect."); 
        }
    }

    function updateUI() {
        // Cache ou montre les boutons de gestion selon l'auth
        const adminElements = document.querySelectorAll('.admin-only');
        adminElements.forEach(el => {
            el.style.display = isAuthenticated ? 'flex' : 'none';
        });
        document.getElementById('lock-btn').innerText = isAuthenticated ? "ðŸ”“" : "ðŸ”’";
        document.getElementById('btn-save').style.display = isAuthenticated ? 'block' : 'none';
    }

    // --- GESTION DE LA LISTE ---
    async function loadFromGithub() {
        const res = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_PATH}?t=${Date.now()}`, {
            headers: { "Authorization": `token ${GH_TOKEN}` }
        });
        if(res.ok) {
            const data = await res.json();
            currentSha = data.sha;
            const raw = decodeURIComponent(escape(atob(data.content)));
            games = JSON.parse(raw);
            document.getElementById('weight-info').innerText = "DATA SIZE: " + (raw.length / 1024).toFixed(1) + " KB";
            render();
        }
        updateUI(); // S'assure que le verrouillage est appliquÃ© au chargement
    }

    function render() {
        const query = document.getElementById('search').value.toLowerCase();
        const list = document.getElementById('game-list');
        list.innerHTML = "";
        let displayList = [...games];
        const ps4Count = games.filter(g => g.console === 'PS4').length;
        const ps5Count = games.filter(g => g.console === 'PS5').length;
        document.getElementById('count-bar').innerText = `${games.length} JEUX | ${ps4Count} PS4 | ${ps5Count} PS5`;

        if(isNewestFirst) { displayList.reverse(); } 
        else { displayList.sort((a,b) => a.title.localeCompare(b.title)); }

        if(currentFilter !== 'ALL') displayList = displayList.filter(g => g.console === currentFilter);
        if(query) displayList = displayList.filter(g => g.title.toLowerCase().includes(query));

        displayList.forEach((g, idx) => {
            const el = document.createElement('div');
            el.className = `game-card ${g.console === 'PS5' ? 'card-ps5' : 'card-ps4'}`;
            el.innerHTML = `
                <div class="game-num">${idx + 1}</div>
                <img src="${g.r}" class="thumb" onclick="openGame(${g.id})">
                <div onclick="openGame(${g.id})" style="flex:1">
                    <div style="font-weight:900; font-size:16px; text-transform:uppercase;">${g.title}</div>
                    <div style="font-size:11px; opacity:0.8; margin-top:3px;">${g.players} ${g.loan ? ' | PrÃªtÃ©: '+g.loan : ''}</div>
                </div>`;
            list.appendChild(el);
        });
    }

    // --- CAPTURE SÃ‰CURISÃ‰E ---
    let step = 1, rectoTemp = null;
    function startSequence() { 
        // DOUBLE VÃ‰RIFICATION DE SÃ‰CURITÃ‰
        if(!isAuthenticated) {
            alert("AccÃ¨s refusÃ©. Veuillez utiliser le cadenas.");
            return;
        }
        step = 1; 
        document.getElementById('cam').click(); 
    }

    document.getElementById('cam').onchange = e => {
        if(!isAuthenticated) return; // SÃ©curitÃ© supplÃ©mentaire
        const fr = new FileReader();
        fr.onload = () => {
            if(step === 1) { rectoTemp = fr.result; step = 2; setTimeout(() => document.getElementById('cam').click(), 400); }
            else { showForm(rectoTemp, fr.result); }
        };
        fr.readAsDataURL(e.target.files[0]);
    };

    function showForm(r, v) {
        if(!isAuthenticated) return;
        activeId = null; document.getElementById('m-r').src = r; document.getElementById('m-v').src = v;
        document.getElementById('m-title').value = ""; 
        document.getElementById('m-price').value = "";
        document.getElementById('m-date').value = "";
        document.getElementById('modal').style.display = 'block';
        setTimeout(() => document.getElementById('m-title').focus(), 400);
    }

    async function saveGame() {
        if(!isAuthenticated) return;
        const btn = document.getElementById('btn-save');
        btn.disabled = true; btn.innerText = "SYNCHRO...";
        const g = { id: activeId || Date.now(), title: document.getElementById('m-title').value, console: selectedConsole, players: document.getElementById('m-players').value, loan: document.getElementById('m-loan').value, price: document.getElementById('m-price').value, date: document.getElementById('m-date').value, r: document.getElementById('m-r').src, v: document.getElementById('m-v').src };
        if(activeId) { const idx = games.findIndex(x => x.id === activeId); games[idx] = g; } else { games.push(g); }
        const res = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_PATH}`, {
            method: "PUT", headers: { "Authorization": `token ${GH_TOKEN}` },
            body: JSON.stringify({ message: "Update", content: btoa(unescape(encodeURIComponent(JSON.stringify(games)))), sha: currentSha })
        });
        if(res.ok) location.reload();
    }

    function openGame(id) {
        const g = games.find(x => x.id === id); 
        activeId = id; 
        selectConsole(g.console || 'PS4');
        document.getElementById('m-title').value = g.title; 
        document.getElementById('m-r').src = g.r;
        document.getElementById('m-v').src = g.v; 
        document.getElementById('m-price').value = g.price || "";
        document.getElementById('m-date').value = g.date || ""; 
        document.getElementById('modal').style.display = 'block';
        
        // Si non authentifiÃ©, on cache le bouton de sauvegarde dans le dÃ©tail
        document.getElementById('btn-save').style.display = isAuthenticated ? 'block' : 'none';
    }

    // --- UTILITAIRES ---
    function openFullscreen(src) {
        document.getElementById('viewer-img').src = src;
        document.getElementById('viewer').style.display = 'block';
        setTimeout(() => { pz = new PinchZoom(document.getElementById('pz-area'), { draggableUnzoomed: false }); }, 100);
    }
    function closeFullscreen() { document.getElementById('viewer').style.display = 'none'; if(pz) pz.destroy(); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function selectConsole(c) { 
        selectedConsole = c; 
        document.getElementById('sel-ps4').style.opacity = c==='PS4'?'1':'0.3'; 
        document.getElementById('sel-ps5').style.opacity = c==='PS5'?'1':'0.3'; 
    }
    function setFilter(f) { currentFilter = f; render(); }
    function toggleSort() { isNewestFirst = !isNewestFirst; document.getElementById('sort-btn').innerText = isNewestFirst ? "A âž” Z" : "NouveautÃ©s"; render(); }

    window.onload = loadFromGithub;
</script>
