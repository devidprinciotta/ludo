<script>
    const CLIENT_ID = '146086087886-mraspoquqjd6n2ntug7sl6t0brsed5fj.apps.googleusercontent.com'; 
    const API_KEY = 'AIzaSyC1M_T9_Pf9kxnbulWhtBy4DzXIwzsTLZ0';

    let db, games = [], step = 1, rectoTemp = null, activeId = null, tokenClient;

    // Base de données interne (Ludo_V17)
    const req = indexedDB.open("PS4_Manager_DB_V17", 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore("games", {keyPath: "id", autoIncrement: true});
    req.onsuccess = e => { db = e.target.result; loadLocal(); };

    function loadLocal() {
        db.transaction("games", "readonly").objectStore("games").getAll().onsuccess = e => {
            games = e.target.result;
            render();
        };
    }

    function render() {
        const list = document.getElementById('game-list');
        list.innerHTML = "";
        games.sort((a,b) => a.title.localeCompare(b.title)).forEach((g, i) => {
            const el = document.createElement('div');
            el.className = 'game-card';
            el.onclick = () => openGame(g.id);
            const loanInfo = g.loan ? `<span class="loan-tag">→ ${g.loan}</span>` : "";
            el.innerHTML = `<b style="color:var(--ps-light); width:20px;">${i+1}</b><img src="${g.r}" class="thumb"><div><b>${g.title}</b>${loanInfo}<br><small>${g.players}</small></div>`;
            list.appendChild(el);
        });
    }

    function startSequence() {
        const btn = document.getElementById('btn-main');
        document.getElementById('cam').onchange = e => {
            const fr = new FileReader();
            fr.onload = () => {
                if(step === 1) { 
                    rectoTemp = fr.result; step = 2; 
                    btn.innerText = "2"; btn.style.background = "#ff9800"; btn.style.color = "white";
                } else { 
                    step = 1; btn.innerText = "+"; btn.style.background = "white"; btn.style.color = "var(--ps-blue)";
                    showForm(rectoTemp, fr.result); 
                }
            };
            fr.readAsDataURL(e.target.files[0]);
        };
        document.getElementById('cam').click();
    }

    function showForm(r, v) {
        activeId = null; document.getElementById('m-title').value = ""; document.getElementById('m-loan').value = "";
        document.getElementById('m-r').src = r; document.getElementById('m-v').src = v;
        document.getElementById('modal').style.display = 'block';
    }

    async function saveGame() {
        const g = { 
            title: document.getElementById('m-title').value || "Sans titre", 
            players: document.getElementById('m-players').value, 
            loan: document.getElementById('m-loan').value, 
            r: document.getElementById('m-r').src, 
            v: document.getElementById('m-v').src 
        };
        const tx = db.transaction("games", "readwrite");
        if(activeId) { g.id = activeId; tx.objectStore("games").put(g); }
        else { tx.objectStore("games").add(g); }
        tx.oncomplete = () => { 
            closeModal(); 
            loadLocal(); 
            // Tentative d'envoi immédiat après sauvegarde
            if (gapi.client.getToken()) { syncToDrive(); }
        };
    }

    // --- LOGIQUE DRIVE V17 (FORCÉE) ---
    function startGapi() {
        gapi.load('client', async () => {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
            initAuth();
        });
    }

    function initAuth() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/drive.file',
            callback: async (resp) => {
                if (resp.access_token) {
                    document.getElementById('status').innerText = "CONNECTÉ";
                    document.getElementById('status').style.color = "#00e676";
                    await pullFromDrive(); // Récupère les données existantes du cloud
                }
            }
        });
    }

    function forceAuth() {
        // Force l'affichage du sélecteur de compte
        tokenClient.requestAccessToken({prompt: 'select_account'});
    }

    async function syncToDrive() {
        const token = gapi.client.getToken();
        if (!token) return;

        document.getElementById('status').innerText = "ENVOI EN COURS...";
        const content = JSON.stringify(games);
        
        // 1. Chercher si le fichier existe déjà
        const listRes = await gapi.client.drive.files.list({
            q: "name='ludo_cloud.json' and trashed=false",
            fields: 'files(id)'
        });
        
        const fileId = listRes.result.files[0]?.id;
        const metadata = { name: 'ludo_cloud.json', mimeType: 'application/json' };

        let url, method;
        if (fileId) {
            url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`;
            method = 'PATCH';
        } else {
            url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
            method = 'POST';
        }

        // Construction manuelle du corps pour éviter les bugs de librairie
        let body;
        if (fileId) {
            body = content;
        } else {
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";
            body = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter + 'Content-Type: application/json\r\n\r\n' + content + close_delim;
        }

        const headers = { 'Authorization': 'Bearer ' + token.access_token };
        if (!fileId) headers['Content-Type'] = 'multipart/related; boundary="' + boundary + '"';

        try {
            const response = await fetch(url, { method: method, headers: headers, body: body });
            if (response.ok) {
                document.getElementById('status').innerText = "SYNCHRONISÉ";
                document.getElementById('status').style.color = "#00e676";
            } else {
                throw new Error('Erreur HTTP');
            }
        } catch (e) {
            document.getElementById('status').innerText = "ÉCHEC ENVOI";
            document.getElementById('status').style.color = "red";
        }
    }

    async function pullFromDrive() {
        const res = await gapi.client.drive.files.list({ q: "name='ludo_cloud.json' and trashed=false" });
        if (res.result.files.length > 0) {
            const fileId = res.result.files[0].id;
            const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                headers: { 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }
            });
            const data = await response.json();
            if (Array.isArray(data)) {
                const tx = db.transaction("games", "readwrite");
                const store = tx.objectStore("games");
                data.forEach(g => store.put(g));
                tx.oncomplete = loadLocal;
                document.getElementById('status').innerText = "DONNÉES RÉCUPÉRÉES";
            }
        }
    }

    function openGame(id) {
        const g = games.find(x => x.id === id); activeId = id;
        document.getElementById('m-title').value = g.title;
        document.getElementById('m-loan').value = g.loan || "";
        document.getElementById('m-r').src = g.r; document.getElementById('m-v').src = g.v;
        document.getElementById('modal').style.display = 'block';
    }

    function openFullscreen(src) {
        const v = document.getElementById('viewer');
        document.getElementById('viewer-img').src = src;
        v.style.display = 'flex';
    }
    function closeViewer() { document.getElementById('viewer').style.display = 'none'; }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
</script>
